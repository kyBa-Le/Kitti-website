<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kitti-Header</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      #nav-link {
        color: #3e6001;
        font-size: 18px;
      }
      #btn-group button, a {
        font-size: 18px;
        font-weight: bold !important;
      }
      #header-nav-icon {
        align-self: center;
        font-size: 18px;
      }

      #defaultDropdown {
        background-color: transparent;
        border: none;
        font-size: 18px;
        color: #3e6001;
      }
      .nav-link:hover,
      #defaultDropdown:hover {
        text-decoration: underline;
      }
      .dropdown-item:hover{
        background-color: #fdc968 !important;
      }
      .btn-outline-secondary:hover {
        background-color: #400219;
      }
      .dropdown-toggle:focus,
      .dropdown-toggle:active {
        border: none;
        outline: none;
        box-shadow: none;
      }
      #searchbar:focus,
      .btn-outline-secondary:focus {
        outline: none;
        box-shadow: none;
        border: 1px solid #3e6001;
      }
      /* CSS cho icon user */
      #logged_in-user-icon {
        padding: 1%;
        position: relative;
        display: inline-block;
      }
      #user-logged {
        font-size: 15px;
        padding: 1rem;
        color: #fff; /* Màu chữ trắng */
        border-radius: 50%;
        border: 2px solid #3e6001;
        cursor: pointer;
        background-color: #3e6001; /* Màu nền xanh từ đầu */
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Đổ bóng nhẹ */
      }
      .login-invisible{
        display: none !important;
      }
      #user-menu{
        position: absolute;
        border: 1px solid black;
        top: 120%;
        right: 10%;
        background-color: antiquewhite;
        width: 400px;
        height: 400px;
        border-radius: 10px;
      }
      #user-image{
        width: 30%;
        margin: 5%;
        border-radius: 10%;
      }
      @media only screen and (max-width: 600px) {
        #user-menu{
        right: -500%;
        width: 300px;
        }
        .fa-angle-up{
          display: block !important;
        }
      }
      /* CSS form thay đổi thông tin user */
      #overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7); /* Màu đen mờ */
          z-index: 999; /* Đảm bảo overlay nằm trên mọi nội dung khác */
      }

      /* Form chỉnh sửa sẽ nổi trên overlay */
      #edit-user-info-form {
          display: none; /* Ẩn form ban đầu */
          position: fixed;
          top: 50%;
          left: 45%; /* Đưa form sang bên trái một chút */
          transform: translate(-50%, -50%); /* Cân chỉnh lại form */
          background-color: white;
          padding: 20px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          z-index: 1000; /* Đảm bảo form nằm trên overlay */
          width: 400px;
          border-radius: 10px;
      }

      #edit-user-info-form h3 {
          margin-bottom: 15px;
      }

      #edit-user-info-form input {
          width: 100%;
          padding: 8px;
          margin-bottom: 15px;
          border: 1px solid #ccc;
          border-radius: 5px;
      }

      #edit-user-info-form button {
          width: 100px;
          padding: 10px;
          background-color: orange;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin-right: 10px;
      }
      
      #close-form-btn{
        margin-left: 135px;

      }
      #edit-user-info-form button:hover {
          background-color: sandybrown;
      }
      /* CSS cho một cái navigation bar phụ để responsive */
      .hidden_header{
        display: none !important;
      }
      #open_header{
        font-size: 30px;
        font-weight: bold;
        color: #3e6001;
      }
      #temporary-header{
        background-color: #f29f05;
        display: flex;
        justify-content: space-between;
        align-items: center;
        *{
          cursor: pointer;
          margin: 0.3rem 0.4rem;
        }
      }
      #fa-angle-up{
        color:#3e6001;
        display: none;
        font-size: 30px;
        box-sizing: border-box;
        padding: 2px;
        border: 1px solid #3e6001;
      }
      @media only screen and (max-width: 600px) {
        #fa-angle-up{
          display: block;
        }
      }
      
/* Kết thúc CSS form thay đổi thông tin user */
    </style>
  </head>
<body>
    <!-- Bắt đầu code phần header -->
    <nav
      class="navbar sticky-top navbar-light bg-light"
      id="header"
      style="background-color: #f29f05 !important"
    >
      <div class="container-fluid">
        <a
          class="navbar-brand"
          href="/public/Home.html"
          style="color: #3e6001; font-size: 32px; font-weight: bold"
        >
          <img
            src="/public/image/Kitti-Logo.jpg"
            alt=""
            width="80"
            height="80"
            class="d-inline-block align-text-center"
            style="border-radius: 50%"
          />
          Kitti
        </a>
        <div class="input-group" style="width: 415px">
          <span
            class="input-group-text"
            id="basic-addon1"
            style="background-color: rgba(255, 255, 255, 0.5)"
            ><i id="header-nav-icon" class="fa-solid fa-magnifying-glass"></i
          ></span>
          <input
            type="text"
            class="form-control"
            placeholder="Tìm công thức hoặc sản phẩm"
            aria-label="Username"
            aria-describedby="basic-addon1"
            style="background-color: rgba(255, 255, 255, 0.5)"
            id="searchbar"
          />
        </div>
        <nav class="nav nav-pills nav-fill">
          <a class="nav-link" href="/public/HTML/Recipe.html" id="nav-link">
            <i id="header-nav-icon" class="fa-solid fa-book"></i> Công thức
          </a>
          <a class="nav-link" href="/public/HTML/Product.html" id="nav-link">
            <i id="header-nav-icon" class="fa-solid fa-bowl-food"></i> Sản phẩm
          </a>
          <a class="nav-link" href="/public/HTML/Cart.html" id="nav-link">
            <i id="header-nav-icon" class="fa-solid fa-cart-shopping"></i> Giỏ
            hàng
          </a>
          <div class="filter-group">
            <div id="btn-group" class="btn-group">
              <button
                class="btn btn-secondary dropdown-toggle"
                type="button"
                id="defaultDropdown"
                data-bs-toggle="dropdown"
                data-bs-auto-close="true"
                aria-expanded="false"
              >
                <i id="header-nav-icon" class="fa-solid fa-filter"></i>
                <span id="filter-content">Tất cả</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="defaultDropdown">
                <li><a class="dropdown-item filter-value" href="#">Chay</a></li>
                <li><a class="dropdown-item filter-value" href="#">Mặn</a></li>
                <li><a class="dropdown-item filter-value" href="#">Tăng cân</a></li>
                <li><a class="dropdown-item filter-value" href="#">Giảm cân</a></li>
                <li><a class="dropdown-item filter-value" href="#">Tất cả</a></li>
              </ul>
            </div>
          </div>
        </nav>
        <div id="btn-group" class="btn-group group-login" role="group" aria-label="Basic outlined example">
          <a class="btn btn-outline-success" href="/public/HTML/LoginAndSignUp.html?request=login" role="button">Đăng nhập</a>
          <a class="btn btn-outline-success" href="/public/HTML/LoginAndSignUp.html?request=signup" role="button">Đăng ký</a>
        </div>
        <!-- Nếu đã đăng nhập thì hiển thị ra icon user -->
        <div id="logged_in-user-icon" class="noclass text-center">
          <i class="fa-solid fa-user" id="user-logged"></i>
          <div class="text-center"><b>Thông tin tài khoản</b></div>
        </div>
        <i class="fa-solid fa-angle-up" id="fa-angle-up"></i>
      </div>
    </nav>
    <!-- Kết thúc phần header -->
    <!-- Code cho phần header phụ để hiển thị cho kích thước điện thoại -->
    <nav id="temporary-header" class="hidden_header">
      <a class="navbar-brand" href="/public/Home.html" style="color: #3e6001; font-size: 28px; font-weight: bold">
        <img src="/public/image/Kitti-Logo.jpg" alt="" width="50" height="50" class="d-inline-block align-text-center"
          style="border-radius: 50%" />
        Kitti
      </a>
      <i class="fa-solid fa-bars" id="open_header"></i>
    </nav>
    <!-- Kết thúc code cho header phụ -->
    <!-- Form chỉnh sửa thông tin người dùng -->
    <div id="edit-user-info-form" style="display: none;">
      <h3>Chỉnh sửa thông tin người dùng</h3>
      <form id="edit-form">
        <label for="edit-username">Tên người dùng:</label>
        <input type="text" id="edit-username" name="username" placeholder="Nhập tên mới"><br>
    
        <label for="edit-phone">Số điện thoại:</label>
        <input type="tel" id="edit-phone" name="phone" placeholder="Nhập số điện thoại mới"><br>
    
        <label for="confirm-password">Mật khẩu:</label>
        <input type="password" id="confirm-password" name="confirm-password" placeholder="Nhập mật khẩu xác nhận thay đổi"><br>
    
        <button type="button" id="save-changes-btn">Lưu thay đổi</button>
        <button type="button" id="close-form-btn">Đóng</button>
      </form>
    </div>
    <script type="module">
      import {UserService} from "/src/Service/UserService.js";
    
      // Điều chỉnh nút lọc
      let dropdownItems = document.getElementsByClassName("dropdown-item");
      for(let i = 0; i < dropdownItems.length; i++){
        dropdownItems[i].addEventListener("click", () => {
          document.getElementById("filter-content").innerHTML = dropdownItems[i].innerHTML;
        });
      }
    
      // Hàm tìm kiếm
      function searchingEvent(){
        const key = document.getElementById("searchbar").value;
        const filter = document.getElementById("filter-content").textContent;
        window.location.href = `/public/HTML/SearchingResult.html?key=${key}&type=${filter}`;
      }

      // Tìm kiếm khi ấn phím enter
      document.getElementById("searchbar").addEventListener("keydown", (event) => {
        if (event.key === 'Enter') {
          searchingEvent();
        }
      });
      // Tìm kiếm khi ở trang tìm kiếm mà ấn nút lọc
      const filters = document.getElementsByClassName("filter-value"); 
      for(let i = 0; i<filters.length; i++){
        filters[i].addEventListener("click", () => {
          if (window.location.href.includes("/public/HTML/SearchingResult.html")) {
            searchingEvent();
            console.log("You have clicked filter!");
          }
        })
      }
      let user_id = localStorage.getItem("user_id");
      if(user_id){
        console.log(localStorage.getItem("user_id"));
        document.getElementsByClassName("group-login")[0].className += " login-invisible";
        renderUserMenu(user_id); // Hiển thị menu khi đã đăng nhập
      } else {
        document.getElementById("logged_in-user-icon").className += " login-invisible";
      }
    
      function logOut(){
        localStorage.removeItem("user_id");
        location.href = "/public/Home.html";
      }
    
      // Hàm chỉnh sửa khi người dùng bấm "Chỉnh sửa"
      async function editUser(event) {
          const userId = event.target.dataset.id;
          const user = await UserService.getUserById(userId);

          if (user) {
        // Hiển thị form chỉnh sửa và điền thông tin người dùng hiện tại
        document.getElementById("edit-user-info-form").style.display = "block";
        
        // Ẩn icon user profile khi form chỉnh sửa hiện ra
        document.getElementById("logged_in-user-icon").style.display = "none";

        document.getElementById("edit-username").value = user.name;
        document.getElementById("edit-phone").value = user.phone;

        // Xử lý khi người dùng lưu thay đổi
        document.getElementById("save-changes-btn").onclick = async function () {
          const newName = document.getElementById("edit-username").value;
          const newPhone = document.getElementById("edit-phone").value;
          const confirmPassword = document.getElementById("confirm-password").value;

          // Kiểm tra nếu người dùng không nhập đủ thông tin
          if (!newName || !newPhone || !confirmPassword) {
            alert("Vui lòng nhập đầy đủ thông tin.");
            return;
          } else if (confirmPassword != user.password) {
            alert("Mật khẩu chưa chính xác. Vui lòng thử lại.");
            return;
          } else {
            // Cập nhật người dùng nếu mật khẩu khớp
            const user = await UserService.getUserById(user_id);
            user.name = newName;
            user.phone = newPhone;
            user.password = confirmPassword;
            
            await UserService.updateUser(user); 
            alert("Cập nhật thông tin thành công!");
            
            // Ẩn form sau khi cập nhật
            document.getElementById("edit-user-info-form").style.display = "none";
            // Hiển thị lại icon user profile khi đóng form
            document.getElementById("logged_in-user-icon").style.display = "block";
            let userMenu = document.getElementById("user-menu");
            if (userMenu.classList.contains("login-invisible")) {
              userMenu.classList.remove("login-invisible");
              userMenu.classList.add("d-flex");
            } else {
              userMenu.classList.add("login-invisible");
              userMenu.classList.remove("d-flex");
            }
          }
        }
      }
        }
      
      // Tạo ra menu account
      function renderUserMenu(user_id){
        let user = UserService.getUserById(user_id);
        let userMenu = `<div class="container-fluid login-invisible flex-column" id="user-menu">
            <div>
              <div class="container-fluid d-flex justify-content-center">
                <img src="https://i.pinimg.com/enabled_hi/564x/1e/f8/15/1ef8156889dba99417ff2b3a6d99988d.jpg" alt="" id="user-image">
              </div>
              <div class="container-fluid d-grid gap-3">
                <div class="row">
                  <div class="col">User name:</div>
                  <div class="col">${user.name}</div>
                </div>
                <div class="row">
                  <div class="col">Phone number:</div>
                  <div class="col">${user.phone}</div>
                </div>
                <div class="row">
                  <div class="col">User id:</div>
                  <div class="col">${user.id}</div>
                </div>
              </div>
            </div>
            <div class="row text-center mt-5">
              <div class="col">
                <button type="button" class="btn btn-outline-dark" id="edit" data-id="${user.id}">Chỉnh sửa</button>
              </div>
              <div class="col">
                <button type="button" class="btn btn-outline-dark" id="logOut">Đăng xuất</button>
              </div>
            </div>
          </div>`;
        document.getElementById("logged_in-user-icon").innerHTML += userMenu;
    
        // Đăng ký sự kiện sau khi thêm menu vào DOM
        document.getElementById("edit").addEventListener('click', editUser);
        document.getElementById("logOut").addEventListener('click', logOut);
      }
      
      // Hiển thị menu account khi ấn vào
      document.getElementById("user-logged").addEventListener('click', () => {
        let userMenu = document.getElementById("user-menu");
        if (userMenu.classList.contains("login-invisible")) {
          userMenu.classList.remove("login-invisible");
          userMenu.classList.add("d-flex");
        } else {
          userMenu.classList.add("login-invisible");
          userMenu.classList.remove("d-flex");
        }
      });
      
      // Đóng form khi nhấn nút "Đóng"
      document.getElementById("close-form-btn").addEventListener('click', () => {
        // Hiển thị lại icon user profile khi đóng form
        let userMenu = document.getElementById("user-menu");
        if (userMenu.classList.contains("login-invisible")) {
          userMenu.classList.remove("login-invisible");
          userMenu.classList.add("d-flex");
        } else {
          userMenu.classList.add("login-invisible");
          userMenu.classList.remove("d-flex");
        }
        document.getElementById("logged_in-user-icon").style.display = "block";
        document.getElementById("edit-user-info-form").style.display = "none"; // Ẩn form chỉnh sửa thông tin
      });
      
      // Đóng form khi nhấn nút "Đóng"
      document.getElementById("close-form-btn").addEventListener('click', () => {
        document.getElementById("edit-user-info-form").style.display = "none"; // Ẩn form chỉnh sửa thông tin
      });
      // Hiển thị lại icon user profile khi đóng form
      document.getElementById("logged_in-user-icon").style.display = "block";

      // Chuyển đổi hiển thị cho header
      let tempoHeader = document.getElementById("temporary-header");
      let header = document.getElementById("header");
      // Hàm mở header ra khi kích thước điện thoại
      function openHeader(tempoHeader, header){
        if (header.classList.contains("hidden_header")) {
          console.log("You have clicked to the hidden menu");
          header.classList.remove("hidden_header");
          tempoHeader.classList.add("hidden_header");
        } else {
          header.classList.add("hidden_header");
          tempoHeader.classList.remove("hidden_header");
        }
      }
      console.log("This is to check  window matchmedia:",window.matchMedia("(max-width:700px)"));
      if(window.matchMedia("(max-width:700px)").matches){
        tempoHeader.classList.remove("hidden_header");
        console.log(tempoHeader.classList);
        header.classList.add("hidden_header");
      }
      document.getElementById("open_header").addEventListener("click",() => openHeader(tempoHeader, header));
      document.getElementById("fa-angle-up").addEventListener("click",() => openHeader(tempoHeader, header));
    </script>
<!-- Kết thúc form chỉnh sửa thông tin người dùng -->
</body>
</html>